DROP TRIGGER IF EXISTS UPD_INSERT_LESSON ON LESSON;
CREATE OR REPLACE FUNCTION upd_lesson()
RETURNS TRIGGER AS
$$
DECLARE
	diff varchar(255);
	code int;
BEGIN
	SELECT DIFFICULTY into diff from MODULES where MODULE_ID=NEW.PARENT_MODULE;
	UPDATE LESSON set DIFFICULTY=diff where LESSON_ID=NEW.LESSON_ID;
	SELECT PARENT_COURSE into code from MODULES where MODULE_ID=NEW.PARENT_MODULE;
	UPDATE MODULES set NUM_LESSONS=NUM_LESSONS+1 where MODULE_ID=NEW.PARENT_MODULE;
	UPDATE COURSE set NUM_LESSONS=NUM_LESSONS+1 where COURSE_ID=code;
    RETURN NEW;
END;
$$
LANGUAGE plpgsql;

CREATE TRIGGER UPD_INSERT_LESSON
AFTER INSERT ON LESSON
FOR EACH ROW
EXECUTE FUNCTION upd_lesson();